#include <time.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_PSWD            20
#define MAX_EXE             20

double time_execution(char* cmd, unsigned int iterations) {
    printf("Timing execution of:\n%s\n", cmd);
    clock_t begin, end;
    for (unsigned int i = 0; i < 5; i++) { //warm up
        system(cmd);
    }
    begin = clock();
    for (unsigned int i = 0; i < iterations; i++) {
        system(cmd);
    }
    end = clock();
    double time_spent = (double)(end - begin) / iterations;
    printf("\nTook: %f\n", time_spent);
    return time_spent;
}

int crack(char* cmd, unsigned int base, unsigned int iterations) {
    int retval = system(cmd) / 256;
    unsigned int index = 0;
    char c = '0';
    while (retval) {
        char best;
        double current, longest = 0;
        if (retval != 1) {
            //error executing target
            return 1;
        }
        if (index >= MAX_PSWD) {
            //unable to crack
            return 1;
        }
        while (1) {
            cmd[base + index] = c;
            current = time_execution(cmd, iterations);
            if (current > longest) {
                longest = current;
                best = c;
            }
            if (c == '9') {
                c = 'A';
                continue;
            }
            if (c == 'Z') {
                c = '_';
                continue;
            }
            if (c == '_') {
                c = 'a';
                continue;
            }
            if (c == 'z') {
                break;
            }
            c++;
        }
        cmd[base + index] = best;

        index++;
        retval = system(cmd) / 256;
    }
    return retval;
}

//usage: ./cracker <path to executable> <iterations per character>
int main(int argc, char *argv[]) {
    char cmd[MAX_EXE + MAX_PSWD + 1] = {0};
    unsigned int iterations, base;
    if (argc != 3) {
        printf("wrong number of arguments");
        return 1;
    }
    strncpy(cmd, argv[1], MAX_EXE);
    iterations = strtol(argv[2], NULL, 10);
    if (cmd[MAX_EXE]) {
        printf("path to executable is too long");
        return 1;
    }
    if (!iterations) {
        printf("illegal number of iterations");
        return 1;
    }
    strcat(cmd, " ");
    base = strlen(cmd);
    return crack(cmd, base, iterations);
}






